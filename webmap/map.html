<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta charset="utf-8"/>
		<meta name="title" content="TIROLTRAILHEAD web map">
		<meta name="author" content="gimoya">
		<meta name="publisher" content="gimoya">
		<meta name="copyright" content="gimoya">
		<meta name="description" content="Routen für XC-/Enduro-/Trial-/Singletrail-Touren in Tirol..">
		<meta name="abstract" content="Routen für XC-/Enduro-/Trial-/Singletrail-Touren in Tirol..">
		<meta http-equiv="content-language" content="de">
		<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
		<meta name="date" content="2014-10-27">
		<meta name="revisit-after" content="30 days">
		<meta name="revisit" content="after 30 days">
		<meta name="DC.Title" content="tiroltrailhead web map">
		<meta name="DC.Creator" content="gimoya">
		<meta name="DC.Rights" content="gimoya">
		<meta name="DC.Publisher" content="gimoya">
		<meta name="DC.Date" content="2014-10-27">
		<meta name="DC.Subject" content="mountainbike bike tirol trail trails singletrail singletrails singletrack enduro freeride freeride-touren">
		<meta name="DC.Relation" content="mountainbike bike tirol trail trails singletrail singletrails singletrack enduro freeride freeride-touren">
		<meta name="DC.Description" content="Routen für XC-/Enduro-/Trial-/Singletrail-Touren in Tirol..">
		<meta name="DC.Language" content="de">
		
		<title>T I R O L T R A I L H E A D</title>
	
		<link rel="shortcut icon" type="image/x-icon" href="images/icon.png" />
		<link rel="stylesheet" href="customstyle.css" type="text/css" />  
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
		<link href='http://fonts.googleapis.com/css?family=Fredoka+One' rel='stylesheet' type='text/css'>
		<link href='http://fonts.googleapis.com/css?family=Bungee' rel='stylesheet' type='text/css'>		
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script src="scripts/bowser.js"></script>
		
		<script type="text/javascript">	
			
			function trim(str) {
				return str.replace(/^\s+|\s+$/g, '');  
			}
			
			var pw_prompt = prompt('Bitte Passwort eingeben, um auf die **tiroltrailhead web map** zu gelangen..',' ');
			var pw = 'keepit';
			// if prompt is cancelled the pw_prompt var will be null!
			if (pw_prompt == null) {
				alert('Kein Passwort wurde angegeben, **tiroltrailhead web map** wird nicht geladen...');
				if (bowser.msie) {
					document.execCommand('Stop');
				} else {
					window.stop();
				}
				window.location='http://gimoya.github.io/tiroltrailhead/webmap/info.html';
			}
			if (trim(pw_prompt) == pw ) {
				alert('Passwort richtig! Mit dem Klicken auf OK stimmst Du dem TIROLTRAILHEAD Kodex (s. http://gimoya.github.io/tiroltrailhead/webmap/info.html) und dem Haftungsausschluss zu!');
			} else {
				alert('Falsches Passwort, **tiroltrailhead web map** wird nicht geladen..');
				if (bowser.msie) {
					document.execCommand('Stop');
				} else {
					window.stop();
				}
				window.location='http://gimoya.github.io/tiroltrailhead/webmap/info.html';
			}
			
			/*
			 * Check Browser and exit if not compatible
			 * using bowser library
			 */
			if (!(bowser.chrome || bowser.firefox || bowser.android || bowser.safari || bowser.ios))
			{
				alert('Die Kompatibilität mit diesem Browser fehlt! Bitte Firefox, Chrome, Safari, Android- oder iOS-Browser verwenden!..');	
				if (bowser.msie) document.execCommand('Stop');
				window.stop();
			}
			
			/* 
			 * toggle button for hiding page elements 
			 */
			$(document).ready(function() {
				$("#ToggleButton").click(function() {
					$("#explanation-and-list").slideToggle("slow");
					$("#output-wrapper").fadeOut("slow");
					$("#onscreen-trails").fadeOut("slow");
					$("#elevation-wrapper").fadeOut("slow");
			  });
				/*
				* Paypal button disapearing after pressing one of the two buttons..
				*/
				$("#x").click(function() {
				  $("#paypal").fadeOut("slow");
				});
				$("#yes").click(function() {
				  $("#paypal").fadeOut("slow");
				});				
			});
			
			/* 
			 * animated scroll of trails list on window load 
			 * to show user clickable trails list
			 */
			$(window).load(function() {
				$(".loader").fadeOut("slow");
				$("#trails-list").animate({scrollTop:300}, 5000);
				$("#trails-list").animate({scrollTop:0}, 2500);				
			});		
		</script>
	</head>
  
	<body style="margin: 0; overflow: hidden;">
		<!-- LOADING PAGE -->
		<div class="loader"></div>
		<!-- LOADING PAGE END -->
		<!-- NAV only used for SITELINKS / display: none; is set in custom-css! -->
		<nav>
			<a id="sitelinks-1" alt="menu-info" href="/info.html" alt="info"></a>
			<a id="sitelinks-2" alt="menu-region-1" href="/map.html#zoom=12&amp;lat=47.39659&amp;lon=11.43351&amp;layers=TF0B0TT" alt="Region1"></a>
			<a id="sitelinks-3" alt="menu-region-2" href="/map.html#zoom=12&amp;lat=47.32885&amp;lon=10.95385&amp;layers=TF0B0TT" alt="Region2"></a>
		</nav>
		<div id="container">
			<div id="explanation-and-list">
				<div id="explanation">
					<p class="H1"><img src="http://gimoya.github.io/tiroltrailhead/webmap/images/logo_trails_5_1.png" width="120" style="vertical-align:middle; padding: 5px;">T I R O L  T R A I L H E A D</p>
					<p class="box3">
						<span class="H2">Basiskarten</span> 	
						</br><strong>OSM:</strong> Open MTB-Map
						</br><strong>Google:</strong> Google Hybrid
						</br><strong>Wanderkarte:</strong> M 1:50000, bis Zoom 16!
						</br>
					</p>
					<p class="box3">
						<span class="H2">Verwendung</span>
						</br><strong>Zoom & Pan mit Maus/Touchpad/etc.</strong>
						</br>Klick auf Trails für Infos und H&ouml;henprofil
						</br>Klick in Karte gibt Koordinaten & Seehöhe
						</br>Vollst&auml;ndige URL leitet zurück zur aktuellen Ansicht
						</br>
					</p>
					<p class="box3">
						<span class="H2">Infos</span>
						</br><input type="button" class="Link" value="Kodex, Trail-Klassifikation, etc." onclick="window.open('info.html')">
						</br>neu: <span id="newest_trail"></span></br>neu: <span id="2nd_newest_trail"></span></br>
					</p>
				</div>			
				<div id="list-wrapper">
					<div id="trails-list">
						<p id="outputListIbk">INNSBRUCK</p>
						<p id="outputListUnterland">ACHENSEE-SCHWAZ-WÖRGL</p>
						<p id="outputListImst">IMST & PITZTAL</p>
						<p id="outputListKufstein">KUFSTEIN & KAISER GEBIRGE</p>
						<p id="outputListKarwendel">KARWENDEL</p>
						<p id="outputListMieminger">MIEMINGER & WETTERSTEIN GEBIRGE</p>
						<p id="outputListOsttirol">OSTTIROL</p>
						<p id="outputListSellrain">SELLRAIN</p>
						<p id="outputListStubai">STUBAITAL</p>
						<p id="outputListOetztal">VORDERES ÖTZTAL & OCHSENGARTEN</p>
						<p id="outputListWipptal">WIPPTAL & SEITENTÄLER</p>
						<!-- hitwebcounter Code START -->
						<a href="http://www.hitwebcounter.com/links.php" target="_blank">
							<img src="http://hitwebcounter.com/counter/counter.php?page=5756788&style=0038&nbdigits=7&type=page&initCount=100" style="border:none; margin-bottom: 20px;">
						</a> 
					</div>
				</div>
			</div>

			<div id="input-div">
				<a id="Overview" onclick="getOverview();"><i class="fa fa-globe fa-4x"></i></<a>
				<a id="ToggleButton"><i class="fa fa-chevron-circle-down fa-4x"></i></a>
				<input type="button" class="Basemap" value="OSM" onclick="map.setBaseLayer(osm);">
				<input type="button" class="Basemap" value="Google" onclick="map.setBaseLayer(ghyb);">
				<input type="button" class="Basemap" value="Kompass" onclick="(map.getZoom() > 16) ? alert('Kompass Karte in dieser Zoom-Stufe nicht verf&uuml;gbar..') : map.setBaseLayer(mapSpecial);">
				<!--input type="button" class="Basemap" value="OEK50" onclick="(map.getZoom() > 15) ? alert('OEK50 in dieser Zoom-Stufe nicht verf&uuml;gbar..') : map.setBaseLayer(mapSpecial);"-->
			</div>
			
			<div id="map"></div>
			<div id="output-wrapper">
				<div id="item-chosen"><!-- JS-Content--></div>
				<div id="elevation-wrapper"><div id="elevation_chart"><!-- JS-Content--></div></div>
				<div id="output-info"><!-- JS-Content--></div>
			</div>
			<div id="onscreen-trails"></div>
			<div id="click-info"></div>
			<!-- PAYPAL --> 
			<div id="paypal">
			  <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" style="margin:0;">
			    <input type="hidden" name="cmd" value="_s-xclick">
			    <input type="hidden" name="hosted_button_id" value="7N6ZTUXZ396XN">
				  <button type="submit" class="support" id="yes">Unterstütze das Projekt mit 1.- oder einem beliebigem Betrag für den Track!</button>
			  </form>
			  <div id="svg_container" class="pulse2">
			    <svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.5 -0.5 25 23.5">
			      <path id="heart" d="M17,0c-1.9,0-3.7,0.8-5,2.1C10.7,0.8,8.9,0,7,0C3.1,0,0,3.1,0,7c0,6.4,10.9,15.4,11.4,15.8 c0.2,0.2,0.4,0.2,0.6,0.2s0.4-0.1,0.6-0.2C13.1,22.4,24,13.4,24,7C24,3.1,20.9,0,17,0z"></path>
			    </svg>
			  </div>
			  <button type="button" class="support" id="x">Dieses mal nicht!..</button>
			</div>
			<!-- PAYPAL END --> 					
		</div>

		<!-- OPENLAYERS PART -->
		<!-- I'll load large scripts here, with loading page being called before..-->
		<script src="http://dev.openlayers.org/releases/OpenLayers-2.13.1/lib/OpenLayers.js"></script>
		<script src="http://maps.google.com/maps/api/js?v=3.2"></script>
		<script src="https://www.google.com/jsapi"></script>
		<script type="text/javascript">
					
			OpenLayers.Util.onImageLoadError = function() {this.style.display="none";}
			
			var proj900913 = new OpenLayers.Projection("EPSG:900913");
			var proj4326 = new OpenLayers.Projection("EPSG:4326");
			
			var map = new OpenLayers.Map( 'map', {
				projection: proj900913,
				displayProjection: proj4326,
				// AUSTRIA: restrictedExtent: new OpenLayers.Bounds(1050550.516554,5839177.463709,1912760.195457,6283123.72391),
				// restrictedExtent: new OpenLayers.Bounds(1183960,5892930,1443020,6047520),
				restrictedExtent: new OpenLayers.Bounds(1180000,5890000,1445000,6066000),
				controls: [new OpenLayers.Control.Navigation(), 
						   // the permalink itself is not used in map, but we need the anchors which it sets to the window location
						   // mind to add the permalink after the ArgParser!!
						   new OpenLayers.Control.ArgParser(),
						   new OpenLayers.Control.Permalink({anchor: true}),
						   new OpenLayers.Control.Attribution()],
				theme: null,
				/* 
				 * show different base maps and map items 
				 * depending on zoom level
				 */
				eventListeners: {
					"zoomend": function() {
						var zLevel = map.getZoom();   
						if(zLevel > 11) {
							KMLpolygons.setVisibility(false);
						} else {
							KMLpolygons.setVisibility(true);
						}	
						if(zLevel < 12) {
							KMLtrails.setVisibility(false);
							pointLayer.setVisibility(false);
						} else {
							KMLtrails.setVisibility(true);
							pointLayer.setVisibility(true);
						}	
						if(map.getZoom() > 16 && this.baseLayer.name == 'Kompass') {
							map.setBaseLayer(osm);
						}							
					}
				}
			});
			
			var ghyb = new OpenLayers.Layer.Google(
				"Google Hybrid",
				{type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
			);
							   
			/* var osm = new OpenLayers.Layer.OSM({numZoomLevels: 20}); 
			
			
		   	var mapSpecial = new OpenLayers.Layer.XYZ("4UMaps", "http://4umaps.eu/${z}/${x}/${y}.png", { numZoomLevels: 16, alpha: true, isBaseLayer: false, attribution: "&#169 4UMaps.eu <a href='http://4Umaps.eu/' target='_parent'>4UMaps</a> <br>Data CC-By-SA by OpenStreetMap" });   
			
			var mapSpecial = new OpenLayers.Layer.OSM("OpenCycleMap",
				  ["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png",
				   "http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png",
				   "http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"]);

			var mapSpecial = new OpenLayers.Layer.OSM("OpenCyclemapMap",
			  "http://tile3.opencyclemap.org/landscape/${z}/${x}/${y}.png")
			
			var mapSpecial = new OpenLayers.Layer.XYZ( "OEK50",
				"http://static5.bergfex.at/images/amap/${z}$folder/${z}_${x}_${y}.png",
				{
					sphericalMercator: true,
					buffer: 0,
					attribution: "&copy; 2008, 2010 BEV, <a href='http://www.bergfex.at'>bergfex GmbH</a>",
					getURL: function(bounds) {
						var path = OpenLayers.Layer.XYZ.prototype.getURL.apply(this, arguments);
						var parts = path.split("$folder/");
						var z = parseInt(parts[0].substr(-2));
						path = path.replace("$folder", z>=14 ?
							"/" + parts[1].substr(3, 2 + z-14) : "");
						return path;
					}
				} );	
			*/
			var osm = new OpenLayers.Layer.XYZ("OpenMTBMap", 
				"http://tile.mtbmap.cz/mtbmap_tiles/${z}/${x}/${y}.png",
				{
				attribution: "&copy; <a href='http://mtbmap.cz/'>MTB Map of Europe</a>"
				});
			
			var mapSpecial = new OpenLayers.Layer.XYZ( "Kompass",
				"http://ec2.cdn.ecmaps.de/WmsGateway.ashx.jpg?Experience=kompass&MapStyle=KOMPASS%20Touristik&TileX=${x}&TileY=${y}&ZoomLevel=${z}",
				{
				sphericalMercator: true,
				buffer: 0,
				attribution: "&copy; <a href='http://www.kompass.de'>Kompass Wanderkarten</a>",
				getURL: function(bounds) {
					var path = OpenLayers.Layer.XYZ.prototype.getURL.apply(this, arguments);
					return path;
					}
				});					
			/* 
			 * default styles for trails 
			 */
			var styleTrails = new OpenLayers.Style({
				strokeColor: "${color}",
				strokeWidth: 6,
				strokeOpacity: 0.6,
				cursor: "pointer"
			});
			
			/* 
			 * default style polygons (=regions) 
			 */
			var stylePolygon = new OpenLayers.Style({
				label: "${name}",
				fontColor: "#42424A",
				fontSize: "22px",
				fontFamily: "Bungee",
				labelOutlineColor: "#FFFFFF", 
				labelOutlineWidth: 2,
				fillColor: "#FBE000",
				fillOpacity: 0.4,
				strokeWidth: 0,
				cursor: "pointer"
			});
				
			var KMLpolygons = new OpenLayers.Layer.Vector("KML", {
				styleMap: new OpenLayers.StyleMap({
					"default": stylePolygon,
					// selected style
					"select": {
						fillColor: "#FBE000",
						cursor: "pointer"
						}
					}),
				projection: map.displayProjection,
				strategies: [new OpenLayers.Strategy.Fixed()],
				protocol: new OpenLayers.Protocol.HTTP({
					url: "digitizing/Regions.kml",
					format: new OpenLayers.Format.KML({
						extractStyles: false, 
						extractAttributes: true,
						maxDepth: 2,
						// 'internalProjection': proj4326,
						// 'externalProjection': proj900913
					})
				})
			});
						
			var KMLtrails = new OpenLayers.Layer.Vector("KML", {
				rendererOptions: { zIndexing: true },
				styleMap: new OpenLayers.StyleMap({
					"default": styleTrails,
					// selected style
					"select": {
						strokeColor: "#FCD20A",
						strokeWidth: 4,
						strokeOpacity: 0.8,						
						cursor: "pointer",
						graphicZIndex: 9999,
						zINdex: 9999
						}
					}),
				projection: map.displayProjection,
				strategies: [new OpenLayers.Strategy.Fixed()],
				protocol: new OpenLayers.Protocol.HTTP({
					url: "digitizing/Trails.kml",
					format: new OpenLayers.Format.KML({
						extractStyles: false, 
						extractAttributes: true,
						maxDepth: 2,
						// 'internalProjection': proj4326,
						// 'externalProjection': proj900913
					})
				})
			});
			
			// make selected feature global, because it is needed for the saveKML function!
			var feature;		
			/*
			 * set selections events for KMLtrails
			 */
			KMLtrails.events.on({
				featureselected: function(event) {
				
				    // hide or display page elements when feature is selected..
					// output-wrapper will be invisble by default and only displays when selected
					$("#output-wrapper").fadeIn("slow");
					$("#explanation-and-list").fadeOut("slow");
					$("#onscreen-trails").fadeOut("slow");
					
					feature = event.feature;
					var name = feature.attributes.name;
					var desc = feature.attributes.description;
					
					// Transform feature and put download link 
					var kmlFormat = new OpenLayers.Format.KML({
						'internalProjection': proj900913,
						'externalProjection': proj4326
					});
					var gpxFormat = new OpenLayers.Format.GPX({
						'internalProjection': proj900913,
						'externalProjection': proj4326
					});
					kmlString = kmlFormat.write(feature);
					gpxString = gpxFormat.write(feature);
					
					// Write feature attributes to output info DIV
					document.getElementById("item-chosen").innerHTML = name;
					document.getElementById("output-info").innerHTML = desc;
					
					// append kmlLink for download, as last line in output
					document.getElementById("topic").appendChild(document.createElement("br"));
					document.getElementById("topic-text").appendChild(document.createElement("br"));
					document.getElementById("topic").innerHTML += "Track:";
					
					if (bowser.firefox || bowser.chrome) {
						// create kmlLink
						const MIME_TYPE = 'text/plain';      
						var bb1 = new Blob([kmlString], {type: MIME_TYPE});
						var bb2 = new Blob([gpxString], {type: MIME_TYPE});
						var kmlLink = document.createElement("a");
						var gpxLink = document.createElement("a");
						kmlLink.href = window.URL.createObjectURL(bb1);
						gpxLink.href = window.URL.createObjectURL(bb2);
						kmlLink.download = name + ".kml";
						gpxLink.download = name + ".gpx";
						kmlLink.innerHTML = "KML";
						gpxLink.innerHTML = "GPX";
						kmlLink.onclick = function () { 		
							$("#paypal").fadeIn("slow");
						}
						gpxLink.onclick = function () { 		
							$("#paypal").fadeIn("slow");
						}						
						document.getElementById("topic-text").appendChild(kmlLink);
						document.getElementById("topic-text").appendChild(document.createTextNode(" | "));
						document.getElementById("topic-text").appendChild(gpxLink);
					} else {
						document.getElementById("topic-text").innerHTML += "..Sorry, Download nicht von allen Browsern untersützt!";
					}	
					document.getElementById("topic").appendChild(document.createElement("br"));					
					document.getElementById("topic-text").appendChild(document.createElement("br"));
					document.getElementById("topic").innerHTML += "Fotos:";
					var instaLink = document.createElement("a");
					instaLink.href = 'https://instagram.com/explore/tags/tiroltrailheadtour' + Number(name.match(/\((\d+)\)/)[1]);
					instaLink.innerHTML = "Instagram";		
					instaLink.target = '_blank';
					document.getElementById("topic-text").appendChild(instaLink);
					// add elevation plot
					addElevPlot(feature);
					//map.zoomToExtent(event.feature.geometry.getBounds(), closest=false);
				},
				featureunselected: function(event) { 
					$("#output-wrapper").fadeOut("slow");
					$("#elevation-wrapper").fadeOut("slow");
				} 
			});
			
			/*
			 * set selections events for KMLpolygons (= regions)
			 */
			KMLpolygons.events.on({
				featureselected: function(event) {
					var feature = event.feature;
					var name = feature.attributes.name;
					var desc = feature.attributes.description;
					document.getElementById("item-chosen").innerHTML = name;
					document.getElementById("output-info").innerHTML = desc;
					$("#output-wrapper").fadeIn("slow");
					$("#explanation-and-list").fadeOut("slow");
					map.setCenter(feature.geometry.bounds.getCenterLonLat(), 12)
					//map.zoomToExtent(event.feature.geometry.getBounds(), closest=true);
				},
				featureunselected: function(event) { 
					$("#output-wrapper").fadeOut("slow");
				} 
			});
			
			
			/* 
			 * make start/end symbols for trails
			 */
			var pointLayer = new OpenLayers.Layer.Vector("Start Points", {
				styleMap: new OpenLayers.StyleMap({
					'default': {
						externalGraphic: 'icons/start.png',
						graphicWidth: 17,
						graphicHeight: 17,
						cursor: "pointer"
					},
					'select': {
						graphicWidth: 22,
						graphicHeight: 22
					}
				})
			});
						
			function makeStartPts(lineLayer) {		
				var pointFeatures = [];
				var features = lineLayer.features;
				for( var i = 0; i < lineLayer.features.length; i++ ) {	
				    var ft = lineLayer.features[i];
					var startPt = ft.geometry.getVertices(nodes = true)[0];  //if nodes = true is set only start and end points will be returned..
					var pointGeometry = new OpenLayers.Geometry.Point(startPt.x, startPt.y);
					var pointFeature = new OpenLayers.Feature.Vector(pointGeometry);
					pointFeature.attributes = {name: ft.attributes.name};
					pointFeatures.push(pointFeature);
				}
				pointLayer.addFeatures(pointFeatures);
			}
			
			pointLayer.events.on({
				featureselected: function(event) {
					var feature = event.feature;
					var name = feature.attributes.name;
					var pos = map.getPixelFromLonLat(feature.geometry.getBounds().getCenterLonLat());
					var posOff = new OpenLayers.Pixel(pos.x + 20, pos.y + 20);
					var latlonOff = map.getLonLatFromPixel(posOff);
					var tooltip = new OpenLayers.Popup.Anchored(
						'featureTooltip',                                   // id
						latlonOff,                                          // lonlat
						null,                                               // contentSize
						'<div id="startpt">-- Startpunkt --<div id="startpt_name">' + name + '</div></div>'                // contentHTML
					);
					tooltip.autoSize = true;
					tooltip.opacity = 0.8;
					feature.tooltip = tooltip;     //	link tooltip to feature for 'out'
					//var offset = {'size':new OpenLayers.Size(0,0),'offset':new OpenLayers.Pixel(-20,-20)};
					//tooltip.anchor = offset;
					map.addPopup(tooltip);
					pointLayer.events.register('mouseout', pointLayer, 
						setTimeout( function() { 
							tooltip.destroy(); 
							selectCtrl.unselectAll();
							}, 2200)
					);
				}
            }); 
			
			// function for selection of trails by attribute name (used in function addTrailsList) 
			function selectByAttr(layer, strValue) {	
				selectCtrl.unselectAll();		
				for(var i = 0; i < layer.features.length; i++) {
					var ft = layer.features[i];
					if(ft.attributes.name == strValue) {
						selectCtrl.select(ft);
						map.zoomToExtent(ft.geometry.getBounds(), closest=false);
						break;
					}
				}
			}
			
			/* 
			 * add marker to trails for elevation plot tooltip
			 * use Elevation API result's xy-coords (need to be back-transformed to map projection!)
			 */	
			var calculateOffset = function(size) {return new OpenLayers.Pixel(-(size.w/2.2), -size.h)};	
			
			/* this function will be used inside the addElevPlot function
			 * for putting the elevation tooltip markers on the map
			 * for a predefined timeout period and afterwards will remove it
			 * <results> is returned by the parent function addElevPlot and <ID>
			 * refers to the id of the point in the results array which is also 
			 * the row-id in the data-table of the chart by which the array-id will be chosen
			 */			
			function makeElevTipMarkers(pos) {
				var markersElevTip = new OpenLayers.Layer.Markers( "Markers" );
				var size = new OpenLayers.Size(50,55);
				var iconElev =  new OpenLayers.Icon('icons/hand-pointer.png', size, null, calculateOffset);
				map.addLayer(markersElevTip);
				markersElevTip.addMarker(new OpenLayers.Marker(pos, iconElev));
				// should be alerted at click event on chart
				// console.log(markersElevTip);
				// center map on marker at current zoom level
				map.setCenter(pos, map.getZoom());
				//zooming:
				for ( var t = 1; t < 40; t++) {
					var time = t*80; 
					window.setTimeout(function() {
							iconElev.setSize(new OpenLayers.Size(iconElev.size.w*0.98, iconElev.size.h*0.98));
						}, time
					);
				}
				window.setTimeout(function() {map.removeLayer(markersElevTip);}, time+8000);
			}
			
			// Load package for Elevation profile visualization and elevation service
			google.load('visualization', '1', {packages: ['corechart']});
			elevator = new google.maps.ElevationService();
				
			function addElevPlot(feature) {
			
				var ft = feature.clone();
				
				// ft length needed for google chart scaling
				var ftGeoLength = ft.geometry.getGeodesicLength(proj900913);
				// console.log("Feature Length (m): " + ftGeoLength);
				
				var verticesMapProj = ft.geometry.getVertices();
				// console.log("Vertices contained at start: " + verticesMapProj.length);
				var vertices_kept = [verticesMapProj[0]];
				var vertices = [];
				for(var i = 0; i < verticesMapProj.length; i++){
					// clone()!!! otherwise original geometry also transformed!!!
					vertices.push(verticesMapProj[i].clone().transform(proj900913, proj4326));
				}

				// make array with googlelocations for later API request
				// initialize with first vertex
				var locs = [new google.maps.LatLng(vertices[0].y, vertices[0].x)];
												 
				// cumulative segment distances between start-node and vertex[i]
				var distance = [0]; 
				var distSum = 0;
				var distMin = 0;
				var j = 0;
				var k = 0;
				// start with second segment, first already in locations array
				for(var i = 1; i < vertices.length; i++) {
					// first element is 0, add segment length to the element before to get cumm. length
					var segment = new OpenLayers.Geometry.LineString([verticesMapProj[i-1], verticesMapProj[i]]);
					var dist = segment.getGeodesicLength(proj900913);
					distSum += dist;
					distMin += dist;
					// OR (vertices.length - 1) will skip conditional testing of dist at last vertex,
					// which should always be kept and not possibly excluded!
					// console.log("Min segment Length at [" + i + "]" + "is: " + distMin);
					if ( i == vertices.length - 1 || distMin > 100 ) {
					    j += 1;
						distMin = 0;
						// console.log("pushed " + j + "times..");
						distance.push(distSum);
						locs.push(new google.maps.LatLng(vertices[i].y, vertices[i].x));
						vertices_kept.push(verticesMapProj[i]);
					}
				}	
				
				// check length of requested array --> should be < 512 per request
				// 2500 requests perday 
				// console.log("positionalRequest ArrayL:\n" + locs.length);				
				// console.log("Distance ArrayL:\n" + distance.length);			
				// console.log("vertices_kept ArrayL:\n" + vertices_kept.length);			
				
				var positionalRequest = {
					'locations': locs
				}				
				
				// get and plot elevations
				elevator.getElevationForLocations(positionalRequest, function(results, status) {
				
					if (status === google.maps.ElevationStatus.OK) {
						var data = new google.visualization.DataTable();
						data.addColumn('number', 'Strecke');
						data.addColumn('number', 'Seehöhe');
						// A column for custom tooltip content
						data.addColumn({type: 'string', role: 'tooltip'});
						// results.length is no. of equidistant samples, from i=0 to i=n
						// thus, cumulative segment length in km is distance*i/1000
						var elevArr = []; // this will hold elevation for later usage
						for (var i = 0; i < results.length; i++) {
							var elev = results[i].elevation;
							elevArr.push(elev); 
							data.addRow([distance[i]/1000,
							             Math.round(elev, 0),
										 // tooltip string in 3rd column
										 // 'Punkt: ' + (i+1) + '\n' +
										 'Strecke: ' + (distance[i]/1000).toFixed(1) + ' km\n' +
										 'Seehöhe: ' + elev.toFixed(0) + ' m ']
							);
						}
			
						// Draw the chart using the data within its DIV.
						$("#elevation-wrapper").fadeIn("slow");
						var chart = new google.visualization.AreaChart(document.getElementById('elevation_chart'));
						var height = Math.round((Math.max.apply(null, elevArr)-Math.min.apply(null, elevArr))*0.0375+150, 0);
						var options = {
							title: 'Höhenprofil',
						    tooltip: { trigger: 'selection' },
						    // use altitude range (max - min) as proportional factor for chart height
							// and trail length for width
							height: height,
							width: ftGeoLength/50+140,
							legend: 'none',
							titleY: 'Seehöhe (m)',
							titleX: 'Strecke (km)',
							backgroundColor: 'transparent',
							fontSize: 12,
							series:{
								0:{
									areaOpacity: 0.4,
									color: 'blue'
								}
							}
						};
						chart.setAction({
							id: 'sample',                    // An id-name is mandatory for all actions.
							text: 'Auf Karte zeigen..',
							action: function() {
								selection = chart.getSelection();
								var ID = selection[0].row;
								makeElevTipMarkers(new OpenLayers.LonLat(vertices_kept[ID].x, vertices_kept[ID].y));
							}
						});							
						chart.draw(data, options);
					} else {
						console.log('Elevation service failed due to: ' + status);
					}
				}); 				
			}		
			
			/* 
			 * add clickable trails list to region-group DIVs 
			 * and save highest trail nr to global var for putting
			 * trail name as 'newest trail' in explanation header
			 */ 
			var name_newest; 
			var name_2ndNewest;
			function addTrailsList () {
			
				var features = KMLtrails.features;				
				var trailNrMax = 1;
				
				for(var i = 0; i < features.length; i++) {
				
					var name = features[i].attributes.name;
					// regex will extract a number surrounded by round brackets and 
					// return an array with 2 elements, the first with the brackets 
					// the second without
					var nr = Number(name.match(/\((\d+)\)/)[1]);
					
					if ( nr > trailNrMax) {
						trailNrMax = nr;
						name_2ndNewest = name_newest;
						name_newest = name;
					}
					
					var descr =  features[i].attributes.description;
					// check for region in description string and if found put to the according DIV
					
					if (descr.indexOf("Achensee-Schwaz-Wörgl") > -1) {
						outputListUnterland.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					}
					
					if (descr.indexOf("Kufstein-Kaiser") > -1) {
						outputListKufstein.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					}
					
					if (descr.indexOf("Innsbruck") > -1) {
						outputListIbk.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					}
					
					if (descr.indexOf("Karwendel") > -1) {
						outputListKarwendel.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					}
					
					if (descr.indexOf("Mieminger") > -1) {
						outputListMieminger.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					} 
					
					if (descr.indexOf("Osttirol") > -1) {
						outputListOsttirol.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					}
					
					if (descr.indexOf("Sellrain") > -1) {
						outputListSellrain.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					}
					
					if (descr.indexOf("Stubaital") > -1) {
						outputListStubai.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;						
					}
					
					if (descr.indexOf("Ötztal") > -1) {
						outputListOetztal.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					}
					
					if (descr.indexOf("Imst-Pitztal") > -1) {
						outputListImst.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;							
					}
					
					if (descr.indexOf("Wipptal") > -1) {
						outputListWipptal.innerHTML += '<li><input type="button" class="Link" value="' + name + '" onclick="selectByAttr(KMLtrails, this.value)"></input></li>';
						continue;
					} else {
						console.log('Caution: Feature with name: "' + name + '" could not be assigned and will be missing in Trails list!!');
					}
				}
			}
			
			/* 
			 * function for Overview button 
			 */
			function getOverview() {
				map.zoomToExtent(KMLpolygons.getDataExtent(), closest=false);
				if ( $("#explanation-and-list").is(":visible") )
					$("#explanation-and-list").slideToggle();
				if ( $("#onscreen-trails").is(":visible") )
					$("#onscreen-trails").css({display: "none"});
				selectCtrl.unselectAll();
			}
			
			map.addLayers([pointLayer, KMLtrails, KMLpolygons, mapSpecial, osm, ghyb]);
			map.raiseLayer(pointLayer, map.layers.length);
						
			/*
			 * function to show trails on current screen
			 * only do this if explanation-and-list DIV is not visible
			 * otherwise hide onscreen trails
			 */
			function showTrailsOnScreen() {				
				if ( !$("#explanation-and-list").is(":visible") && map.getZoom() > 11) {
					var output = [];
					var features = KMLtrails.features;
					for (var i=0;i<features.length;i++) {
						var ft = features[i];
						if (ft.onScreen()){
							output.push(ft.attributes.name);
						}
					}
					// then, use output to display the list in html...
					document.getElementById("onscreen-trails").innerHTML = 
						'<div id="onscreen-trails-inner">Trails im Bild</br></div>..' + 
						output.join("</br>..");	
					$("#onscreen-trails").fadeIn("slow");	
				} else {
					$("#onscreen-trails").fadeOut("slow");
				}
			};
			
			/*
			 * assign showTrailsOnScreen to moveend event
			 */
			map.events.register("moveend", map, function(evt) {
				showTrailsOnScreen();
			});
			
			if (!map.getCenter()) {
				map.setCenter(new OpenLayers.LonLat(1269858.137, 5986332.222), 13);
			} else {
				// if map has center passed from ArgParser, this center will be used
				// and explanation-and-list DIV should be hidden
				document.getElementById("explanation-and-list").style.display = "none";
			};
			
			/* 
			 * register load end of KMLtrails, 
			 * then add start markers and trails list, etc.
			 */
			KMLtrails.events.register("loadend", KMLtrails, function (e) {
				// map.zoomToExtent(KMLtrails.getDataExtent());
				makeStartPts(KMLtrails);
				addTrailsList();
				showTrailsOnScreen();
				/* put number of covered trails
				 * to the HTML
			 	*/
				document.getElementById("newest_trail").innerHTML = '<input type="button" class="Link" id="new_trail_1" value="' + name_newest + '" onclick="selectByAttr(KMLtrails, this.value)"></input>';
				document.getElementById("2nd_newest_trail").innerHTML = '<input type="button" class="Link" id="new_trail_2" value="' + name_2ndNewest + '" onclick="selectByAttr(KMLtrails, this.value)"></input>';
			});
			
			/*
			 * register 'beforefeatureadded' event and add color attribute 
			 * that is used for custom styling of KX-trails
			 */
			KMLtrails.events.register("beforefeatureadded", KMLtrails, 
				function(event) {
					var a = event.feature.attributes;
					// trails with KX classification should be red
					a.color = a.description.indexOf('KX') > -1 ? "#E53E38" : "#1F5AAA";
					// trails with ? classification (unknown, planned but not yet been there) should be pink
					if (a.description.indexOf('?') > -1) {a.color = "#FF69B4"}
					// trails with ! classification (been there, and it was shit) should be grey
					if (a.description.indexOf('!') > -1) {a.color = "#BCBCBC"}
					return true;
				}
			);
			
			var selectCtrl = new OpenLayers.Control.SelectFeature([KMLpolygons, KMLtrails, pointLayer]);
			map.addControl(selectCtrl);
			selectCtrl.activate();
	
			OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
                defaultHandlerOptions: {
                    'single': true,
                    'double': false,
                    'pixelTolerance': 5,
                    'stopSingle': false,
                    'stopDouble': false
                },

                initialize: function(options) {
                    this.handlerOptions = OpenLayers.Util.extend(
                        {}, this.defaultHandlerOptions
                    );
                    OpenLayers.Control.prototype.initialize.apply(
                        this, arguments
                    ); 
                    this.handler = new OpenLayers.Handler.Click(
                        this, {
                            'click': this.trigger
                        }, this.handlerOptions
                    );
                }, 

                trigger: function(e) {
                    var lonlat = map.getLonLatFromPixel(e.xy).transform(proj900913, proj4326);
					var locations = [new google.maps.LatLng(lonlat.lat, lonlat.lon)];
					//console.log(lonlat);
					var positionalRequest = {
						'locations': locations
					}
					// get and plot elevations
					elevator.getElevationForLocations(positionalRequest, function(results, status) {
						if (status == google.maps.ElevationStatus.OK) {
							var elevArr = []; // this will hold elevation for later usage
							for (var i = 0; i < results.length; i++) {
								elevArr.push(results[i].elevation); 
							}
						}
						var msg = "WGS84: "+ parseFloat(lonlat.lat.toFixed(2)) + " N, " + parseFloat(lonlat.lon.toFixed(2)) + 
						          " E</br>Seehöhe: " + parseFloat(elevArr[0].toFixed(0)) + " m";
						document.getElementById("click-info").innerHTML = msg;
					});
                }
            });
			
			var click = new OpenLayers.Control.Click();
			map.addControl(click);
			click.activate();
			
		</script>
  </body>
</html>
