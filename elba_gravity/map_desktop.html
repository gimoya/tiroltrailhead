<html>
<head>
<title>ELBA GRAVITY PARK</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">	
	<link rel="stylesheet" href="http://watson.lennardvoogdt.nl/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css">
	
	<!-- GOOGLE FONTS -->	
	<link href='http://fonts.googleapis.com/css?family=Bangers|Fugaz+One|Hanalei+Fill|Ranga|Ultra|Exo:Bold|Fredoka+One|Sigmar+One|Bungee+Inline|Creepster|Ewert|Fruktur|Monoton|Rubik:900' rel='stylesheet' type='text/css'>	
	<!-- GOOGLE FONTS -->

	
	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	<script src="//lightwidget.com/widgets/lightwidget.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>	
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.js"></script>
	<script src="http://watson.lennardvoogdt.nl/Leaflet.awesome-markers/dist/leaflet.awesome-markers.js"></script>

    <style type="text/css">
	    
	html, body {
		font-size: 100%;
		height: 100%;
		padding: 0;
		margin: 0;
	}
	    
	#map {
		position: absolute;
		width: 100%;
		height: 100%;
	}	    
	    
	.awesome-marker i {
	    font-size: 16px;
	    margin-top: 10px;
	}
	    
	.custom-control {
		font-family: Exo;
	}
	 
	/* 
	custom link styling:
	*/  
	a {
		transition: color .4s;
	}

	a:link, a:visited { 
		color: #f9ff00; 
	}

	a:hover   { color: #7FDBFF; }
	a:active  {
		transition: color .3s;
		color: #007BE6;
	}	
	
	// exception for control links..
	a.leaflet-control-zoom-in, a.leaflet-control-zoom-out {
	    color: black!important;
	}
	    
	#infopanel-left {
		display: none; 
		position: absolute; 
		bottom: 0px;
		left: 0px;
		z-index: 100; 
		background-color: rgba(0,0,0,0.70); 
		width: 30%; 
		height: 100%;
		color: white;
	}
	    
	#infopanel-right {
		display: none;
		position: absolute;	
		bottom: 0px;
		right: 0px;
		padding: 0 10 16 10px;
		z-index: 100; 
		background-color: rgba(0,0,0,0.30);		
		color: white;
	}
	    
	#photos {
		max-width: 100%;
		min-height: 62%;
	}
	
	#title {
		font-size: 2.3em;
		padding: 10px;
	}
	    
	#trail-info, #tracks {
		font-family: 'Corbel', 'bold';
		padding: 10 0 0 10px;
	}
	
	
	#poi-info {
		font-family: 'Corbel', 'bold';
		font-size: 1.9em;
		font-weight: bold;
	}	
	
	#popup {
		z-index:9999;
		position: absolute;
		padding: 2px 6px 2px 6px;
		background-color: white;
		display: none;
		border-radius: 4px;
		box-shadow: 2px 2px 2px #888888;
	}
	
	@media screen and (max-height: 600px), (max-width: 860px) {
		body {
			font-size: 75%;
		}
		#infopanel-left, #infopanel-right {
			max-width: 50%; 
		}	
		#tracks {
			font-size: 1.75em;
		}
		#trail-info {
			display: none;
		}
	}
   
   .IT, .EN {
		max-height: 7em;
		overflow-y: scroll;
	}
	
   .IT {
	  display: block;
	}

	.EN {
	  display: none;
	}

	.IT-Click,
	.EN-Click {
	   cursor: hand; 
	   color: #f9ff00;
	}
	</style>
</head>
	
<body>
	<div id="popup"></div>
	<div id="infopanel-right">
		<div class="info-row" id="poi-info"></div>
	</div>
	<div id="infopanel-left">
		<div id="photos"></div>		
		<div class="info-row" id="title"></div>
		<div class="info-row" id="trail-info"></div>
		<div class="info-row" id="tracks">
			<a id="gpx" href="">GPX</a> | <a id="kml" href="">KML</a>
		</div>
	</div>
	<div id="map"></div>
	
	<script language="javascript">	

		var map = L.map('map', {
		  center: [42.808660, 10.393714],
		  zoom: 13,
		  maxZoom: 17,
		  minZoom: 11,
		  zoomControl: false
		});
		
		map.on('click', function() {
			$("#infopanel-left").fadeOut("slow");
			$("#infopanel-right").fadeOut("slow");
		});
		
		new L.Control.Zoom({ position: 'topright' }).addTo(map);

		var toggle = L.easyButton({
		  position: 'topright',
		  states: [{
			stateName: 'basemap-outdoor',
			icon: '<span class="custom-control">T</span>',
			title: 'change basemap back to satellite',		
			onClick: function(control) {
			  map.removeLayer(mapbox_outdoorLayer);
			  map.addLayer(mapbox_satelliteLayer);
			  control.state('basemap-satellite');
			}
		  }, {
			stateName: 'basemap-satellite',
			icon: '<span class="custom-control">S</span>',
			title: 'change basemap to outdoor/terrain',
			onClick: function(control) {
			  map.removeLayer(mapbox_satelliteLayer);
			  map.addLayer(mapbox_outdoorLayer);
			  control.state('basemap-outdoor');
			},
		  }]
		});	

		toggle.addTo(map);

		var mapbox_Attr = 'Tiles &copy; <a href="https://www.mapbox.com">mapbox</a>';  
		var mapbox_satelliteUrl = 'https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2ltb3lhIiwiYSI6IkZrTld6NmcifQ.eY6Ymt2kVLvPQ6A2Dt9zAQ';
		var mapbox_outdoorUrl = 'https://api.mapbox.com/styles/v1/mapbox/outdoors-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2ltb3lhIiwiYSI6IkZrTld6NmcifQ.eY6Ymt2kVLvPQ6A2Dt9zAQ';

		var mapbox_satelliteLayer = L.tileLayer(mapbox_satelliteUrl, {
		  attribution: mapbox_Attr 
		});

		var mapbox_outdoorLayer = L.tileLayer(mapbox_outdoorUrl, {
		  attribution: mapbox_Attr 
		});		

		mapbox_outdoorLayer.addTo(map);		

		var trailColors = {
			"Miniere": "#6dc066",
			"Strega": "#ffd700", 
			"Mezza Strega": "#ff0000",
			"Scalette": "#66cccc",
			"Vignola": "#8a2be2",
			"Cavo": "#0099cc",
			"Serra": "#ffb6c1",
			"Buca Del Bandito": "#000000"
		};

		
		// use one version of the kml layers for outline styling
		
		var CavoKML_outline = omnivore.kml('KML/Cavo.kml');		
		var SerraKML_outline = omnivore.kml('KML/Serra.kml');
		var BucaDelBanditoKML_outline = omnivore.kml('KML/BucaDelBandito.kml');
		var MiniereKML_outline = omnivore.kml('KML/Miniere.kml');
		var MezzaStregaKML_outline = omnivore.kml('KML/MezzaStrega.kml');
		var StregaKML_outline = omnivore.kml('KML/Strega.kml');
		var ScaletteKML_outline = omnivore.kml('KML/Scalette.kml');
		var VignolaKML_outline = omnivore.kml('KML/Vignola.kml');
		
		var groupKML_outline = new L.LayerGroup([
			SerraKML_outline,
			MiniereKML_outline,
			BucaDelBanditoKML_outline,	
			MezzaStregaKML_outline,
			ScaletteKML_outline,
			StregaKML_outline,
			VignolaKML_outline,
			CavoKML_outline
		]);
		
		groupKML_outline.eachLayer(function (layer) {	
			layer.on('ready', function() { 			
				layer.setStyle({
					'color': 'white',
					'weight': 8					
				});
			});	
		});
		
		map.addLayer(groupKML_outline);		
		
		// now the KML tracks with events and all that..
		
		function trailClick(e, font) {
				$("#title").html(e.layer.feature.properties.name);
				$("#title").css('color', trailColors[e.layer.feature.properties.name]);
				$("#title").css("font-family", font);
				$("#trail-info").html(e.layer.feature.properties.description);
				$("#infopanel-left").fadeIn("slow");
				$(".IT-Click").on('click', function() {
					$(".EN").css("display", "none");
					$(".IT").css("display", "block");
				});
				$(".EN-Click").on('click', function() {
					$(".IT").css("display", "none");
					$(".EN").css("display", "block");
				});	
				map.fitBounds(e.layer.getBounds());				
		}

		var CavoKML = omnivore.kml('KML/Cavo.kml')
			.on('click', function(e) {
				trailClick(e, "Bangers");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/6d167f1931505782a4628f3b1d29d22f.html" scrolling="no" allowtransparency="true" class="lightwidget-widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/Cavo.gpx');
				$("#kml").prop('href', 'KML/Cavo.kml');
			});
			
		var SerraKML = omnivore.kml('KML/Serra.kml')
			.on('click', function(e) {
				trailClick(e, "Fruktur");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/e535e22ef1aa5ccd857aa7219956df32.html" scrolling="no" allowtransparency="true" class="lightwidget-widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/Serra.gpx');
				$("#kml").prop('href', 'KML/Serra.kml');
			});

		var BucaDelBanditoKML = omnivore.kml('KML/BucaDelBandito.kml')
			.on('click', function(e) {
				trailClick(e, "Creepster");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/994b9682508659809d63287e94e522d6.html" scrolling="no" allowtransparency="true" class="lightwidget-7widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/BucaDelBandito.gpx');
				$("#kml").prop('href', 'KML/BucaDelBandito.kml');
			});			

		var MiniereKML = omnivore.kml('KML/Miniere.kml')
			.on('click', function(e) {
				trailClick(e, "Ultra");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/7cfa1a27909850c1a5eb5d022fef31c9.html" scrolling="no" allowtransparency="true" class="lightwidget-widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/Miniere.gpx');
				$("#kml").prop('href', 'KML/Miniere.kml');
			});			

		var MezzaStregaKML = omnivore.kml('KML/MezzaStrega.kml')
			.on('click', function(e) {
				trailClick(e, "Ewert");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/cc84f0d9d7b9595885992cd3a18d0d38.html" scrolling="no" allowtransparency="true" class="lightwidget-widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/MezzaStrega.gpx');
				$("#kml").prop('href', 'KML/MezzaStrega.kml');
			});

		var StregaKML = omnivore.kml('KML/Strega.kml', null)
			.on('click', function(e) {
				trailClick(e, "Fugaz One");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/bb59eb0d5ecc520e99203b6560267003.html" scrolling="no" allowtransparency="true" class="lightwidget-widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/Strega.gpx');
				$("#kml").prop('href', 'KML/Strega.kml');
			});

		var ScaletteKML = omnivore.kml('KML/Scalette.kml')
			.on('click', function(e) {
				trailClick(e, "Hanalei");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/7920ebe9426c5b4aa4235de3f5eab748.html" scrolling="no" allowtransparency="true" class="lightwidget-widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/Scalette.gpx');
				$("#kml").prop('href', 'KML/Scalette.kml');
			});			

		var VignolaKML = omnivore.kml('KML/Vignola.kml')
			.on('click', function(e) {
				trailClick(e, "Bungee Inline");
				$("#photos").html('<iframe src="//lightwidget.com/widgets/1b8944eef7c85a2c8552a30a8d1da7e8.html" scrolling="no" allowtransparency="true" class="lightwidget-widget" style="width: 100%; border: 0; overflow: hidden;"></iframe>');
				$("#gpx").prop('href', 'KML/Vignola.gpx');
				$("#kml").prop('href', 'KML/Vignola.kml');
			});

		/*
		For highlighting features see:
		http://stackoverflow.com/questions/32971673/how-do-you-make-a-highlighted-outline-appear-in-leaflet-js-on-mouseover-and-by-h
		Maybe cleaner here: http://bl.ocks.org/bsudekum/5431771
		*/	

		var style = {
			'default': {
				'opacity': 0.75
			},		
			'highlight': {
				'opacity': 0.85
			}
		};

		// Variable for storing highlighted layer
		var highlight;

		function setHighlight (layer) {
		  // Check if something's highlighted, if so unset highlight
		  if (highlight) {
			unsetHighlight(highlight);
		  }
		  // Set highlight style on layer and store to variable
		  layer.setStyle(style.highlight);
		  highlight = layer;
		}

		function unsetHighlight (layer) {
		  // Set default style and clear variable
		  layer.setStyle(style.default);
		  highlight = null;
		}

		var groupKML = new L.LayerGroup([
			SerraKML,
			MiniereKML,
			BucaDelBanditoKML,	
			MezzaStregaKML,
			ScaletteKML,
			StregaKML,
			VignolaKML,
			CavoKML
		]);	
		
		// used icons for markers:
		L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';

		var bikeRentIcon = L.AwesomeMarkers.icon({
			    icon: 'fa-bicycle',
			    markerColor: 'blue',
			    iconColor: 'yellow'
			  });	

		var bikeLoadingIcon = L.AwesomeMarkers.icon({
			    icon: 'fa-truck',
			    markerColor: 'purple',
			    iconColor: 'yellow'
			  });	

		function openShopURL(e) {
			$("#poi-info").css('color', 'white'); 
			$("#poi-info").html('Go to</br><a href="http://www.elbagravitybikerent.it/" target="_blank";>Elba Gravity</br>Bike Shop/Rent</a>');
			$("#infopanel-right").fadeIn("slow");
			$("#poi-info").fadeIn("slow");		
		}

		function showBikeShuttle(e) {
			$("#poi-info").css('color', 'white'); 
			$("#poi-info").html('Bike loading point: ' + e.target.properties.place + '</br>' + 'Call <a href="tel:+39 320 264 9391">+39 320 264 9391</a>');
			$("#infopanel-right").fadeIn("slow");
			$("#poi-info").fadeIn("slow");			
		}
		

		bikeLoadingPts = new Array();
		bikeLoadingPts.push({Place: 'Bagnaia', 'Lat': 42.810156, 'Lon': 10.363514});
		bikeLoadingPts.push({Place: 'Cavo', 'Lat': 42.860381, 'Lon': 10.420435});
		bikeLoadingPts.push({Place: 'Vignola Exit - SP33', 'Lat': 42.843782, 'Lon': 10.400274});
		bikeLoadingPts.push({Place: 'Magazzini', 'Lat': 42.799289, 'Lon':10.357636});
		bikeLoadingPts.push({Place: 'Porto Azzurro', 'Lat': 42.770250, 'Lon': 10.390604});
		bikeLoadingPts.push({Place: 'Rio Marina', 'Lat': 42.815970, 'Lon': 10.428423});
		
		new L.marker([42.81376, 10.3989717], {icon: bikeRentIcon})
			.on('click', openShopURL)
			.addTo(map);	
		
		for (i = 0; i < bikeLoadingPts.length; i++) { 
			marker = new L.marker([ bikeLoadingPts[i].Lat, bikeLoadingPts[i].Lon ], {icon: bikeLoadingIcon});
			marker.properties = {};
			marker.properties.place = bikeLoadingPts[i].Place;
			marker.on('click', showBikeShuttle);
			marker.addTo(map);
		}
		
		// Iterate over groupKML and make end and start markers, then attach event listeners..	
		groupKML.eachLayer(function (layer) {	

			layer.on('ready', function() { 
			
				var latlngs = layer.getLayers(0)[0]._latlngs;
				var name = layer.getLayers(0)[0].feature.properties.name;
				
				// Add start point for each layer
				new L.circleMarker(latlngs[0], {
						color: 'darkslategrey',
						fillColor: 'lightgreen',
						fillOpacity: 1,					
						radius: 8
					})
					// Mouseover handler for start/end points
					.on('mouseover', function (e) {
						// put div to click xy
						var containerPoint = map.latLngToContainerPoint(e.latlng);
						$("#popup").html('Start - ' + name.toUpperCase() + ' Trail');
						$("#popup").css('color', trailColors[name]);
						$('#popup').css({'left': containerPoint.x+10});
						$('#popup').css({'top': containerPoint.y+10});
						$("#popup").fadeIn("slower");
					})
					// Mouseout handler for start/end points
					.on('mouseout', function (e) {
						$("#popup").fadeOut("slower");
					})
					.addTo(map);					
					
				// Add end points for each layer
				new L.circleMarker(latlngs[latlngs.length - 1], {
						color: 'darkslategrey',
						fillColor: 'pink',
						fillOpacity: 1,
						radius: 8
					})
					// Mouseover handler for start/end points
					.on('mouseover', function (e) {
						// put div to click xy
						var containerPoint = map.latLngToContainerPoint(e.latlng);
						$("#popup").html('End - ' + name.toUpperCase() + ' Trail');
						$("#popup").css('color', trailColors[name]);
						$('#popup').css({'left': containerPoint.x+10});
						$('#popup').css({'top': containerPoint.y-20});
						$("#popup").fadeIn("slower");
					})
					// Mouseout handler for start/end points
					.on('mouseout', function (e) {
						$("#popup").fadeOut("slower");
					})
					.addTo(map);
				
				// color each trail accordingly
				layer.setStyle({
					'opacity': 0.75,
					'weight': 5,
					'color': trailColors[name]
				});
			});			

			// Mouseover handler for trails
			layer.on('mouseover', function (e) {
				// Set highlight
				setHighlight(layer);
			});

			// Mouseout handler for trails
			layer.on('mouseout', function (e) {
				 // Unset highlight
				unsetHighlight(layer);
				$("#popup").fadeOut("slower");
			});	
		});
		
		map.addLayer(groupKML);	
		
		/* get width of info-panel (25 or 50% of screen) and 
		   use this value for height, because iframe will be quadratic and fill 100%
		   of parent divs #photos and #infopanel-left
		   This way the KML-name, which is diplayed in the div that's floating below, and is faster 
		   loaded, will not be shifted farther to the bottom, when iframe is ready latter!
		*/
		$(document).ready(function() {
		  $('#photos').css({'height': $('#infopanel-left').width()});		
		});
	</script>
</body>	
</html>